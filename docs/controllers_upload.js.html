<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: controllers/upload.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: controllers/upload.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**
 
 * @module upload
 */


const ErrorResponse = require('../utils/errorResponse');
const asyncHandler = require('../middleware/async');
const AWS=require('aws-sdk')
const uuid=require('uuid/v1')
const Upload = require('../models/Upload');

const s3=new AWS.S3({
    accessKeyId:process.env.accessKeyId,
    secretAccessKey:process.env.secretAccessKey
})



// @desc      upload image to aws-s3
// @route     GET /api/v1/upload
// @access    auth user


  /**
 * upload image to aws s3 
* @typedef {Function} upload
 * @property {String} file - image to uploade 
 * @property {String} route - GET /api/v1/upload
 * @property {String} access -auth user
 */

exports.upload = asyncHandler(async (req, res, next) => {

    const key=`${req.user.id}/${uuid()}.jpeg`
    const file = req.files.file;
    
    if (!file) {
        return next(new ErrorResponse(`Please upload a file`, 400));
      }
      /**
           * params required to connect with aws
           * @typedef {Object} params
           * @property {string} Bucket -aws bucket used to upload file inside it 
           * @property {date} Expires -Image url generated url expire 
           * @property {string} key -key will used with front end 
           * @property {string} ResponseContentType -the file type to uploade is image/png
           */
       const params = {
        Bucket: 'upload-image-1', 
        Key: key, 
        Expires: 60, 
        ResponseContentType: 'image/png'
      };



      
      s3.getSignedUrl('getObject', params, async (err, url) =>{
        if (url) {
           //save to data base 
           const file = await Upload.create({url,key});
          /**
           * response when upload image 
           * @typedef {Object} image
           * @property {string} id -Image Id in mongo db data base 
           * @property {string} url -Image url generated by aws 
           * @property {string} key -key will used with front end 
           */
        res.status(201).json({
                success: true,
                // data: {url,key},
                file
              })}
        else {return next(new ErrorResponse(err, 400))}
      }
      );



  });</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Jsdoc uploade image in aws s3 assignment</a></h2><h3>Modules</h3><ul><li><a href="module-upload.html">upload</a></li></ul><h3>Global</h3><ul><li><a href="global.html#connectDB">connectDB</a></li><li><a href="global.html#errorHandler">errorHandler</a></li><li><a href="global.html#express">express</a></li><li><a href="global.html#helmet">helmet</a></li><li><a href="global.html#morgan">morgan</a></li><li><a href="global.html#xss">xss</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.6</a> on Mon Mar 15 2021 23:07:00 GMT+0200 (Eastern European Standard Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
